name: Auto Deploy to Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # æœåŠ¡å™¨é…ç½® - éœ€è¦åœ¨ GitHub Secrets ä¸­è®¾ç½®
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_SSH_RSA: ${{ secrets.SERVER_SSH_RSA }}
  
  # Docker é•œåƒé…ç½®
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [pinco, r3-admin-front, r3-admin-server]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: '${{ matrix.service }}/pnpm-lock.yaml'

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: |
        cd ${{ matrix.service }}
        pnpm install

    - name: Run lint (if available)
      run: |
        cd ${{ matrix.service }}
        if [ -f "package.json" ] && grep -q "lint" package.json; then
          pnpm run lint || echo "Lint script not found, skipping..."
        fi
      continue-on-error: true

    - name: Run tests (if available)
      run: |
        cd ${{ matrix.service }}
        if [ -f "package.json" ] && grep -q "test" package.json; then
          pnpm run test || echo "Test script not found, skipping..."
        fi
      continue-on-error: true

  # æ„å»º Docker é•œåƒ
  build:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [pinco, r3-admin-front, r3-admin-server]
    
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.service }}
        file: ./${{ matrix.service }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_RSA }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Create deployment directory
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /opt/pros"

    - name: Copy docker-compose files to server
      run: |
        scp docker-compose.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pros/
        scp -r nginx/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pros/

    - name: Create production docker-compose override
      run: |
        cat > docker-compose.prod.yml << EOF
        version: '3'
        services:
          pinco:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/pinco:latest
            build: null
          
          r3-admin-front:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/r3-admin-front:latest
            build: null
          
          r3-admin-server:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/r3-admin-server:latest
            build: null
            environment:
              - NODE_ENV=production
              - PORT=9506
              - DB_TYPE=mysql
              - DB_HOST=\${{ secrets.DB_HOST || 'host.docker.internal' }}
              - DB_PORT=\${{ secrets.DB_PORT || '3306' }}
              - DB_DATABASE=\${{ secrets.DB_DATABASE || 'r3' }}
              - DB_USERNAME=\${{ secrets.DB_USERNAME }}
              - DB_PASSWORD=\${{ secrets.DB_PASSWORD }}
              - DB_SYNC=false
              - JWT_SECRET=\${{ secrets.JWT_SECRET }}
              - JWT_EXPIRE=\${{ secrets.JWT_EXPIRE || '4h' }}
            nginx: {}
        EOF
        scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pros/

    - name: Login to registry on server
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin"

    - name: Deploy application
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /opt/pros
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
          
          # åœæ­¢æ—§å®¹å™¨
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          
          # æ¸…ç†æ— ç”¨é•œåƒ
          docker image prune -f
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
        EOF

    - name: Health check
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # æ£€æŸ¥ Nginx æ˜¯å¦æ­£å¸¸è¿è¡Œ
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "âœ… Nginx is running"
          else
            echo "âŒ Nginx health check failed"
            exit 1
          fi
          
          # æ£€æŸ¥åç«¯ API æ˜¯å¦å“åº”
          if curl -f http://localhost/r3/api/health > /dev/null 2>&1; then
            echo "âœ… Backend API is running"
          else
            echo "âš ï¸  Backend API health check failed (this might be expected if no health endpoint exists)"
          fi
        EOF

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
          echo "ç®¡ç†åå°: http://${{ secrets.SERVER_HOST }}/r3-admin/"
          echo "åšå®¢: http://${{ secrets.SERVER_HOST }}/"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi
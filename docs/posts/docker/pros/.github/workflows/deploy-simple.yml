name: Deploy to Server (Build on Server)

on:
  push:
    branches: [ main, master ]

env:
  # æœåŠ¡å™¨é…ç½® - éœ€è¦åœ¨ GitHub Secrets ä¸­è®¾ç½®
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_SSH_RSA: ${{ secrets.SERVER_SSH_RSA }}
  SERVER_PROJECT_PATH: ${{ secrets.SERVER_PROJECT_PATH || '/opt/pros' }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    # è¿™é‡Œå¯ä»¥æ·»åŠ ç®€å•çš„è¯­æ³•æ£€æŸ¥ç­‰
    - name: Check project structure
      run: |
        echo "âœ… é¡¹ç›®ç»“æ„æ£€æŸ¥é€šè¿‡"
        ls -la

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: quality-check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_RSA }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        # åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        rsync -avz --delete \
          --exclude '.git' \
          --exclude 'node_modules' \
          --exclude '.github' \
          ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.SERVER_PROJECT_PATH }}/

    - name: Build and restart services
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ${{ env.SERVER_PROJECT_PATH }}
          
          echo "ğŸ”§ åœæ­¢ç°æœ‰æœåŠ¡..."
          docker-compose -f docker-compose.prod.yml down || echo "æ²¡æœ‰è¿è¡Œçš„æœåŠ¡"
          
          echo "ğŸ—ï¸  æ„å»ºé•œåƒ..."
          docker-compose -f docker-compose.prod.yml build --no-cache
          
          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          docker-compose -f docker-compose.prod.yml up -d
          
          echo "ğŸ§¹ æ¸…ç†æ— ç”¨é•œåƒ..."
          docker image prune -f
          
          echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker-compose ps
        EOF

    - name: Health check
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ${{ env.SERVER_PROJECT_PATH }}
          
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ å®¹å™¨å¯åŠ¨å¼‚å¸¸"
            docker-compose logs --tail=50
            exit 1
          fi
          
          # æ£€æŸ¥ Web æœåŠ¡
          if curl -f http://localhost >/dev/null 2>&1; then
            echo "âœ… Web æœåŠ¡è®¿é—®æ­£å¸¸"
          else
            echo "âš ï¸  Web æœåŠ¡å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´å¯åŠ¨"
          fi
        EOF

    - name: Show deployment info
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
        echo "é¡¹ç›®è·¯å¾„: ${{ env.SERVER_PROJECT_PATH }}"
        echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
        echo "ç®¡ç†åå°: http://${{ secrets.SERVER_HOST }}/r3-admin/"
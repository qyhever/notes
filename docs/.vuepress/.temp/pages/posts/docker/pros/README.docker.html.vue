<template><div><h1 id="dockerå¤šé¡¹ç›®éƒ¨ç½²æŒ‡å—" tabindex="-1"><a class="header-anchor" href="#dockerå¤šé¡¹ç›®éƒ¨ç½²æŒ‡å—"><span>Dockerå¤šé¡¹ç›®éƒ¨ç½²æŒ‡å—</span></a></h1>
<p>æœ¬æ–‡æ¡£æä¾›äº†ä½¿ç”¨Dockeréƒ¨ç½²å¤šä¸ªé¡¹ç›®çš„è¯¦ç»†è¯´æ˜ï¼ŒåŒ…æ‹¬qyheveråšå®¢ã€r3-admin-frontå‰ç«¯å’Œr3-admin-serveråç«¯æœåŠ¡ã€‚</p>
<h2 id="é¡¹ç›®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®ç»“æ„"><span>é¡¹ç›®ç»“æ„</span></a></h2>
<ul>
<li><strong>nginx</strong>: ä¸» nginxï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰è·¯ç”±å’Œ API ä»£ç†ï¼Œè®¿é—®è·¯å¾„ä¸ºæ ¹ç›®å½• <code v-pre>http://localhost/</code></li>
<li><strong>qyhever</strong>: åšå®¢é¡¹ç›®ï¼Œè®¿é—®è·¯å¾„ä¸º <code v-pre>http://localhost/blog/</code></li>
<li><strong>r3-admin-front</strong>: ç®¡ç†å‰ç«¯é¡¹ç›®ï¼Œè®¿é—®è·¯å¾„ä¸º <code v-pre>http://localhost/r3-admin/</code></li>
<li><strong>r3-admin-server</strong>: ç®¡ç†åç«¯APIæœåŠ¡ï¼Œä¸ºr3-admin-frontæä¾›APIæ”¯æŒ</li>
</ul>
<h2 id="æ–‡ä»¶è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶è¯´æ˜"><span>æ–‡ä»¶è¯´æ˜</span></a></h2>
<ul>
<li><code v-pre>docker-compose.yml</code>: å®šä¹‰äº†æ‰€æœ‰æœåŠ¡çš„Dockeré…ç½®</li>
<li><code v-pre>nginx</code>: Nginxé…ç½®æ–‡ä»¶ï¼Œé™æ€ç›®å½•ï¼Œæ—¥å¿—ç›®å½•</li>
<li>å„é¡¹ç›®ç›®å½•ä¸‹çš„Dockerfile: å®šä¹‰äº†å„ä¸ªé¡¹ç›®çš„æ„å»ºå’Œè¿è¡Œç¯å¢ƒ</li>
<li>å„é¡¹ç›®ç›®å½•ä¸‹çš„.dockerignore: å¿½ç•¥æŸäº›æ–‡ä»¶æˆ–ç›®å½•</li>
</ul>
<h2 id="éƒ¨ç½²æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²æ­¥éª¤"><span>éƒ¨ç½²æ­¥éª¤</span></a></h2>
<h3 id="_1-å®‰è£…dockerå’Œdocker-compose" tabindex="-1"><a class="header-anchor" href="#_1-å®‰è£…dockerå’Œdocker-compose"><span>1. å®‰è£…Dockerå’ŒDocker Compose</span></a></h3>
<p>ç¡®ä¿æ‚¨çš„ç³»ç»Ÿå·²å®‰è£…Dockerå’ŒDocker Composeã€‚</p>
<h3 id="_2-æ„å»ºå’Œå¯åŠ¨å®¹å™¨" tabindex="-1"><a class="header-anchor" href="#_2-æ„å»ºå’Œå¯åŠ¨å®¹å™¨"><span>2. æ„å»ºå’Œå¯åŠ¨å®¹å™¨</span></a></h3>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆåŒ…å«docker-compose.ymlçš„ç›®å½•ï¼‰ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token comment"># æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰å®¹å™¨</span></span>
<span class="line"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å®¹å™¨çŠ¶æ€</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token function">ps</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å®¹å™¨æ—¥å¿—</span></span>
<span class="line"><span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿›å…¥ nginx</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx /bin/sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹ r3-admin-server æœåŠ¡æ—¥å¿—(æœ€æ–°20æ¡è®°å½•)</span></span>
<span class="line"><span class="token function">docker-compose</span> logs r3-admin-server <span class="token parameter variable">--tail</span><span class="token operator">=</span><span class="token number">20</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é‡å¯nginx</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx nginx <span class="token parameter variable">-s</span> reload</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥nginx.confæ˜¯å¦é…ç½®æ­£ç¡®</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx nginx <span class="token parameter variable">-t</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é‡å¯ r3-admin-server æœåŠ¡</span></span>
<span class="line"><span class="token function">docker-compose</span> up <span class="token parameter variable">--build</span> r3-admin-server <span class="token parameter variable">-d</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-è®¿é—®åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#_3-è®¿é—®åº”ç”¨"><span>3. è®¿é—®åº”ç”¨</span></a></h3>
<ul>
<li>é¦–é¡µ: http://localhost/</li>
<li>åšå®¢: http://localhost/blog/</li>
<li>ç®¡ç†å‰ç«¯: http://localhost/r3-admin/</li>
<li>ç®¡ç†åç«¯API: http://localhost/r3/api/</li>
</ul>
<h2 id="é…ç½®è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#é…ç½®è¯´æ˜"><span>é…ç½®è¯´æ˜</span></a></h2>
<h3 id="nginxé…ç½®" tabindex="-1"><a class="header-anchor" href="#nginxé…ç½®"><span>Nginxé…ç½®</span></a></h3>
<p><code v-pre>nginx/nginx.conf</code>æ–‡ä»¶é…ç½®äº†ï¼š</p>
<ul>
<li>å°†æ ¹è·¯å¾„è¯·æ±‚é…ç½®./nginx/htmlä¸ºé™æ€ç›®å½•</li>
<li>å°†/blog/è·¯å¾„è¯·æ±‚è½¬å‘åˆ°qyheveråšå®¢æœåŠ¡</li>
<li>å°†/r3-admin/è·¯å¾„è¯·æ±‚è½¬å‘åˆ°r3-admin-frontæœåŠ¡</li>
<li>å°†/r3/api/è·¯å¾„è¯·æ±‚è½¬å‘åˆ°r3-admin-serveræœåŠ¡</li>
</ul>
<h3 id="å„é¡¹ç›®é…ç½®" tabindex="-1"><a class="header-anchor" href="#å„é¡¹ç›®é…ç½®"><span>å„é¡¹ç›®é…ç½®</span></a></h3>
<ul>
<li><strong>qyhever</strong>: ä½¿ç”¨VuePressæ„å»ºé™æ€åšå®¢ï¼Œå¹¶ä½¿ç”¨Nginxæä¾›æœåŠ¡</li>
<li><strong>r3-admin-front</strong>: Vue3é¡¹ç›®ï¼Œæ„å»ºåä½¿ç”¨Nginxæä¾›æœåŠ¡</li>
<li><strong>r3-admin-server</strong>: neståç«¯æœåŠ¡</li>
</ul>
<h2 id="è‡ªå®šä¹‰é…ç½®" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰é…ç½®"><span>è‡ªå®šä¹‰é…ç½®</span></a></h2>
<h3 id="ä¿®æ”¹ç«¯å£" tabindex="-1"><a class="header-anchor" href="#ä¿®æ”¹ç«¯å£"><span>ä¿®æ”¹ç«¯å£</span></a></h3>
<p>å¦‚éœ€ä¿®æ”¹å¯¹å¤–æš´éœ²çš„ç«¯å£ï¼Œè¯·ç¼–è¾‘<code v-pre>docker-compose.yml</code>æ–‡ä»¶ä¸­nginxæœåŠ¡çš„<code v-pre>ports</code>éƒ¨åˆ†ï¼š</p>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code><span class="line"><span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token string">"æ–°ç«¯å£:80"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¿®æ”¹é¡¹ç›®è·¯å¾„" tabindex="-1"><a class="header-anchor" href="#ä¿®æ”¹é¡¹ç›®è·¯å¾„"><span>ä¿®æ”¹é¡¹ç›®è·¯å¾„</span></a></h3>
<p>å¦‚éœ€ä¿®æ”¹é¡¹ç›®è®¿é—®è·¯å¾„ï¼Œéœ€è¦ï¼š</p>
<ol>
<li>ä¿®æ”¹<code v-pre>nginx/nginx.conf</code>ä¸­çš„locationé…ç½®</li>
<li>å¯¹äºå‰ç«¯é¡¹ç›®ï¼Œå¯èƒ½è¿˜éœ€è¦ä¿®æ”¹å…¶æ„å»ºé…ç½®ï¼ˆå¦‚vite.config.tsä¸­çš„baseé…ç½®ï¼‰</li>
</ol>
<h2 id="æ•…éšœæ’é™¤" tabindex="-1"><a class="header-anchor" href="#æ•…éšœæ’é™¤"><span>æ•…éšœæ’é™¤</span></a></h2>
<h3 id="r3-api-è·¯å¾„è¯·æ±‚å¤±è´¥é—®é¢˜æ’æŸ¥" tabindex="-1"><a class="header-anchor" href="#r3-api-è·¯å¾„è¯·æ±‚å¤±è´¥é—®é¢˜æ’æŸ¥"><span>/r3/api/ è·¯å¾„è¯·æ±‚å¤±è´¥é—®é¢˜æ’æŸ¥</span></a></h3>
<p>æŸ¥çœ‹ä¸» nginx é…ç½®ä¸­çš„ /r3/api/ è·¯å¾„é…ç½®ï¼Œç¡®ä¿è¯¥è·¯å¾„è¢«æ­£ç¡®è½¬å‘åˆ° r3-admin-server åç«¯æœåŠ¡ã€‚</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token comment"># r3-admin-server API - ä»£ç†/r3/apiåˆ°åç«¯æœåŠ¡</span></span>
<span class="line">location /r3/api/ <span class="token punctuation">{</span></span>
<span class="line">  proxy_pass http://r3-admin-server:9506/<span class="token punctuation">;</span></span>
<span class="line">  proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span></span>
<span class="line">  proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span></span>
<span class="line">  proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span></span>
<span class="line">  proxy_set_header X-Forwarded-Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœé…ç½®æ­£ç¡®æˆ–å·²ä¿®æ”¹æ­£ç¡®ï¼Œæ£€æŸ¥ r3-admin-server åç«¯æœåŠ¡æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> r3-admin-server <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token parameter variable">-d</span> <span class="token string">'{"mobile":"test","password":"test"}'</span> http://localhost:9506/auth/login</span>
<span class="line"></span>
<span class="line"><span class="token comment"># output</span></span>
<span class="line"><span class="token comment"># OCI runtime exec failed: exec failed: unable to start container process: exec: "curl": executable file not found in $PATH: unknown</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>curl ä¸å¯ç”¨ï¼Œå› ä¸º Alpine å®¹å™¨æ²¡æœ‰ curlã€‚ç”¨ nginx å®¹å™¨æ¥æµ‹è¯•åç«¯è¿æ¥ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx <span class="token function">wget</span> -qO- --post-data<span class="token operator">=</span><span class="token string">'{"mobile":"test","password":"test"}'</span> <span class="token parameter variable">--header</span><span class="token operator">=</span><span class="token string">'Content-Type: application/json'</span> http://r3-admin-server:9506/auth/login</span>
<span class="line"></span>
<span class="line"><span class="token comment"># output</span></span>
<span class="line"><span class="token comment"># wget: can't connect to remote host (172.18.0.4): Connection refused</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰è¿æ¥é—®é¢˜ï¼æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> logs r3-admin-server <span class="token parameter variable">--tail</span><span class="token operator">=</span><span class="token number">10</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>åç«¯æœåŠ¡å¯åŠ¨æ­£å¸¸ã€‚æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx <span class="token function">nslookup</span> r3-admin-server</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token comment"># output</span></span>
<span class="line">Server:		<span class="token number">127.0</span>.0.11</span>
<span class="line">Address:	<span class="token number">127.0</span>.0.11:53</span>
<span class="line"></span>
<span class="line">Non-authoritative answer:</span>
<span class="line">Name:	r3-admin-server</span>
<span class="line">Address: <span class="token number">172.18</span>.0.4</span>
<span class="line"></span>
<span class="line">Non-authoritative answer:</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç½‘ç»œè§£ææ­£å¸¸ã€‚æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> nginx <span class="token function">nc</span> <span class="token parameter variable">-zv</span> r3-admin-server <span class="token number">9506</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>æ²¡æœ‰è¾“å‡º<code v-pre>r3-admin-server (172.18.0.4:9506) open</code>ï¼Œopenå…³é”®è¯ï¼Œå‘ç°é—®é¢˜ã€‚</p>
<p>r3-admin-server nest.jsé¡¹ç›® main.ts ä¸­ï¼Œåº”ç”¨ç›‘å¬çš„ç«¯å£æ˜¯ process.env.PORT ?? 3000ï¼Œè€Œä¸æ˜¯å›ºå®šçš„ 9506ã€‚ä½†æ˜¯ docker-compose å’Œ Dockerfile ä¸­æœŸæœ›çš„æ˜¯ 9506 ç«¯å£ã€‚</p>
<p>ç¼ºå°‘ PORT ç¯å¢ƒå˜é‡ï¼åœ¨ docker-compose.yml ä¸­æ·»åŠ  PORT ç¯å¢ƒå˜é‡ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line">environment:</span>
<span class="line">  - <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production</span>
<span class="line">  - <span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">9506</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‡æ–°å¯åŠ¨ r3-admin-server æœåŠ¡ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> up <span class="token parameter variable">--build</span> r3-admin-server <span class="token parameter variable">-d</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>æ£€æŸ¥ r3-admin-server çš„æ—¥å¿—ï¼Œç¡®è®¤å®ƒæ­£åœ¨æ­£ç¡®çš„ç«¯å£ç›‘å¬ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">docker-compose</span> logs r3-admin-server <span class="token parameter variable">--tail</span><span class="token operator">=</span><span class="token number">10</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>æœåŠ¡å·²ç»é‡æ–°å¯åŠ¨äº†ã€‚ç°åœ¨æµ‹è¯• /r3/api/auth/login æ¥å£ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code><span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token parameter variable">-d</span> <span class="token string">'{"mobile":"test","password":"test"}'</span> http://localhost/r3/api/auth/login</span>
<span class="line"></span>
<span class="line"><span class="token comment"># output</span></span>
<span class="line"><span class="token comment"># {"data":null,"success":false,"msg":"æ‰‹æœºå·ä¸æ­£ç¡®"}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ‰ æˆåŠŸ!</p>
<p>é—®é¢˜æ ¹æº</p>
<ol>
<li>è·¯å¾„ä¸åŒ¹é…ï¼šå‰ç«¯æœŸæœ› /r3/api/auth/loginï¼Œä½† nginx åªé…ç½®äº† /r3-admin/api/ è·¯å¾„</li>
<li>ç«¯å£é…ç½®é”™è¯¯ï¼šåç«¯åº”ç”¨ç›‘å¬ process.env.PORT ?? 3000ï¼Œä½† docker-compose æ²¡æœ‰è®¾ç½® PORT ç¯å¢ƒå˜é‡ï¼Œå¯¼è‡´åº”ç”¨ç›‘å¬ 3000 ç«¯å£è€Œä¸æ˜¯æœŸæœ›çš„ 9506 ç«¯å£</li>
</ol>
</div></template>


